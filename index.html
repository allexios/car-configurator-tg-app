<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Конфигуратор автомобиля</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Стили остаются прежними */
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error {
            text-align: center;
            padding: 20px;
            color: #ff4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading" class="loading">
            Загрузка данных...
        </div>

        <div id="app-content" style="display: none;">
            <!-- Шаг 1: Выбор марки -->
            <div class="step active" id="step-brand">
                <h1>Выберите марку автомобиля</h1>
                <div id="brands-container">
                    <!-- Бренды будут загружены динамически -->
                </div>
            </div>

            <!-- Остальные шаги остаются похожими, но с динамической загрузкой -->
            <!-- Шаг 2: Выбор модели -->
            <div class="step" id="step-model">
                <h1 id="model-title">Выберите модель</h1>
                <div class="back-to-brands">
                    <a class="back-link" onclick="backToBrands()">← Вернуться к выбору марки</a>
                </div>
                <div id="models-container">
                    <!-- Модели будут загружены динамически -->
                </div>
            </div>

            <!-- Шаг 3: Выбор цвета -->
            <div class="step" id="step-color">
                <h1>Выберите цвет</h1>
                <div class="back-to-brands">
                    <a class="back-link" onclick="backToModel()">← Вернуться к выбору модели</a>
                </div>
                <div id="colors-container">
                    <!-- Цвета будут загружены динамически -->
                </div>
            </div>

            <!-- Шаг 4: Дополнительные опции -->
            <div class="step" id="step-options">
                <h1>Дополнительные опции</h1>
                <div class="back-to-brands">
                    <a class="back-link" onclick="backToColor()">← Вернуться к выбору цвета</a>
                </div>
                <div id="options-container">
                    <!-- Опции будут загружены динамически -->
                </div>
            </div>

            <!-- Шаг 5: Итоговая конфигурация -->
            <div class="step" id="step-summary">
                <h1>Ваша конфигурация</h1>
                <div class="back-to-brands">
                    <a class="back-link" onclick="backToOptions()">← Вернуться к опциям</a>
                </div>
                <div id="summary-content"></div>
                <div class="total-price" id="total-price">Итого: 0 ₽</div>
                <button class="btn-primary" onclick="sendToManager()">Отправить менеджеру</button>
            </div>

            <!-- Навигация -->
            <div class="navigation">
                <div class="button-group">
                    <button class="btn-secondary" id="btn-prev" onclick="prevStep()" disabled>Назад</button>
                    <button class="btn-primary" id="btn-next" onclick="nextStep()">Далее</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Конфигурация API
        // const API_BASE_URL = 'https://your-backend-api.com/api'; // Замените на ваш API
        // Или для тестирования можно использовать JSON файл на GitHub:
        const API_BASE_URL = 'https://raw.githubusercontent.com/allexios/car-configurator-tg-app/main';

        // Глобальные данные
        let brandsData = [];
        let modelsData = {};
        let colorsData = [];
        let optionsData = [];

        // Текущее состояние конфигурации
        const configuration = {
            brand: null,
            model: null,
            color: null,
            options: [],
            basePrice: 0,
            totalPrice: 0
        };

        const steps = ['step-brand', 'step-model', 'step-color', 'step-options', 'step-summary'];
        let currentStep = 0;

        // Инициализация Telegram Web App
        const tg = window.Telegram.WebApp;

        // Загрузка данных при старте
        async function initializeApp() {
            try {
                tg.expand();
                tg.BackButton.hide();

                // Загружаем все данные
                await loadAllData();
                
                // Скрываем loading и показываем контент
                document.getElementById('loading').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                
                // Инициализируем интерфейс
                initializeBrands();
                showStep(0);
                
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
                document.getElementById('loading').innerHTML = 
                    '<div class="error">Ошибка загрузки данных. Пожалуйста, попробуйте позже.</div>';
            }
        }

        // Загрузка всех данных
        async function loadAllData() {
            try {
                // Вариант 1: Загрузка из API
                const [brands, colors, options] = await Promise.all([
                    fetch(`${API_BASE_URL}/brands`).then(r => r.json()),
                    fetch(`${API_BASE_URL}/colors`).then(r => r.json()),
                    fetch(`${API_BASE_URL}/options`).then(r => r.json())
                ]);

                // Вариант 2: Загрузка из JSON файлов на GitHub
                /*
                const [brands, colors, options] = await Promise.all([
                    fetch(`${API_BASE_URL}/brands.json`).then(r => r.json()),
                    fetch(`${API_BASE_URL}/colors.json`).then(r => r.json()),
                    fetch(`${API_BASE_URL}/options.json`).then(r => r.json())
                ]);
                */

                brandsData = brands;
                colorsData = colors;
                optionsData = options;

            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
                throw error;
            }
        }

        // Загрузка моделей для конкретного бренда
        async function loadModels(brandId) {
            if (modelsData[brandId]) {
                return modelsData[brandId];
            }

            try {
                // Вариант 1: Загрузка из API
                const models = await fetch(`${API_BASE_URL}/brands/${brandId}/models`).then(r => r.json());
                
                // Вариант 2: Загрузка из JSON файла
                // const models = await fetch(`${API_BASE_URL}/models-${brandId}.json`).then(r => r.json());
                
                modelsData[brandId] = models;
                return models;
                
            } catch (error) {
                console.error('Ошибка загрузки моделей:', error);
                return [];
            }
        }

        // Инициализация брендов
        function initializeBrands() {
            const container = document.getElementById('brands-container');
            
            if (brandsData.length === 0) {
                container.innerHTML = '<div class="error">Нет доступных брендов</div>';
                return;
            }

            container.innerHTML = brandsData.map(brand => `
                <div class="brand-card" data-brand="${brand.id}">
                    <div class="brand-name">${brand.name}</div>
                    <div class="brand-description">${brand.description}</div>
                </div>
            `).join('');

            // Добавляем обработчики событий
            document.querySelectorAll('.brand-card').forEach(card => {
                card.addEventListener('click', async function() {
                    document.querySelectorAll('.brand-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    configuration.brand = this.dataset.brand;
                    
                    // Показываем загрузку моделей
                    const modelsContainer = document.getElementById('models-container');
                    modelsContainer.innerHTML = '<div class="loading">Загрузка моделей...</div>';
                    
                    // Загружаем модели для выбранного бренда
                    const models = await loadModels(configuration.brand);
                    initializeModels(models);
                    
                    // Переходим к выбору модели
                    setTimeout(() => {
                        currentStep = 1;
                        showStep(currentStep);
                    }, 300);
                });
            });
        }

        // Инициализация моделей
        function initializeModels(models) {
            const container = document.getElementById('models-container');
            const brandName = brandsData.find(b => b.id === configuration.brand)?.name || '';

            if (models.length === 0) {
                container.innerHTML = '<div class="error">Нет доступных моделей</div>';
                return;
            }

            container.innerHTML = models.map(model => `
                <div class="model-card" data-model="${model.id}" data-price="${model.price}">
                    <div class="model-name">${model.name}</div>
                    <div class="model-price">от ${formatPrice(model.price)} ₽</div>
                    <ul>
                        ${model.features.map(feature => `<li>${feature}</li>`).join('')}
                    </ul>
                </div>
            `).join('');

            // Обновляем заголовок
            document.getElementById('model-title').textContent = `Выберите модель ${brandName}`;

            // Добавляем обработчики событий
            document.querySelectorAll('.model-card').forEach(card => {
                card.addEventListener('click', function() {
                    document.querySelectorAll('.model-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    configuration.model = this.dataset.model;
                    configuration.basePrice = parseInt(this.dataset.price);
                    calculateTotal();
                });
            });
        }

        // Инициализация цветов
        function initializeColors() {
            const container = document.getElementById('colors-container');
            
            container.innerHTML = colorsData.map(color => `
                <div class="color-option ${color.isPremium ? 'premium' : ''}" 
                     data-color="${color.id}" 
                     data-price="${color.price}"
                     style="background: ${color.hexCode}; ${color.id === 'white' ? 'border: 1px solid #ccc;' : ''}">
                    ${color.isPremium ? '<div class="premium-badge">+</div>' : ''}
                </div>
            `).join('');

            // Добавляем обработчики событий
            document.querySelectorAll('.color-option').forEach(color => {
                color.addEventListener('click', function() {
                    document.querySelectorAll('.color-option').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    configuration.color = this.dataset.color;
                    calculateTotal();
                });
            });
        }

        // Инициализация опций
        function initializeOptions() {
            const container = document.getElementById('options-container');
            
            container.innerHTML = optionsData.map(option => `
                <div class="option-item" data-option="${option.id}" data-price="${option.price}">
                    <span>${option.name}</span>
                    <span class="option-price">+${formatPrice(option.price)} ₽</span>
                </div>
            `).join('');

            // Добавляем обработчики событий
            document.querySelectorAll('.option-item').forEach(option => {
                option.addEventListener('click', function() {
                    this.classList.toggle('selected');
                    
                    const optionId = this.dataset.option;
                    const optionPrice = parseInt(this.dataset.price);
                    
                    if (this.classList.contains('selected')) {
                        if (!configuration.options.includes(optionId)) {
                            configuration.options.push(optionId);
                        }
                    } else {
                        configuration.options = configuration.options.filter(opt => opt !== optionId);
                    }
                    
                    calculateTotal();
                });
            });
        }

        // Навигация по шагам
        function showStep(stepIndex) {
            steps.forEach((step, index) => {
                const element = document.getElementById(step);
                if (index === stepIndex) {
                    element.classList.add('active');
                } else {
                    element.classList.remove('active');
                }
            });

            document.getElementById('btn-prev').disabled = stepIndex === 0;
            document.getElementById('btn-next').textContent = stepIndex === steps.length - 1 ? 'Завершить' : 'Далее';

            // Инициализируем контент для каждого шага
            if (stepIndex === 2) {
                initializeColors();
            } else if (stepIndex === 3) {
                initializeOptions();
            } else if (stepIndex === steps.length - 1) {
                updateSummary();
            }
        }

        // Остальные функции (nextStep, prevStep, calculateTotal, updateSummary и т.д.)
        // остаются похожими, но используют динамические данные

        function nextStep() {
            if (currentStep < steps.length - 1) {
                currentStep++;
                showStep(currentStep);
            } else {
                tg.showPopup({
                    title: 'Готово!',
                    message: 'Конфигурация сохранена.',
                    buttons: [{ type: 'ok' }]
                });
            }
        }

        function prevStep() {
            if (currentStep > 0) {
                currentStep--;
                showStep(currentStep);
            }
        }

        function calculateTotal() {
            let total = configuration.basePrice;
            
            const selectedColor = document.querySelector('.color-option.selected');
            if (selectedColor) {
                total += parseInt(selectedColor.dataset.price);
            }
            
            document.querySelectorAll('.option-item.selected').forEach(option => {
                total += parseInt(option.dataset.price);
            });
            
            configuration.totalPrice = total;
            
            if (currentStep === steps.length - 1) {
                updateSummary();
            }
        }

        function updateSummary() {
            const summaryContent = document.getElementById('summary-content');
            const totalPriceElement = document.getElementById('total-price');
            
            const brand = brandsData.find(b => b.id === configuration.brand);
            const model = modelsData[configuration.brand]?.find(m => m.id === configuration.model);
            const color = colorsData.find(c => c.id === configuration.color);
            
            let html = `
                <div class="summary-item">
                    <span>Марка:</span>
                    <span>${brand?.name || 'Не выбрано'}</span>
                </div>
                <div class="summary-item">
                    <span>Модель:</span>
                    <span>${model?.name || 'Не выбрано'}</span>
                </div>
                <div class="summary-item">
                    <span>Базовая цена:</span>
                    <span>${formatPrice(configuration.basePrice)} ₽</span>
                </div>
            `;
            
            if (color) {
                html += `
                    <div class="summary-item">
                        <span>Цвет (${color.name}):</span>
                        <span>+${formatPrice(color.price)} ₽</span>
                    </div>
                `;
            }
            
            if (configuration.options.length > 0) {
                html += `<div class="summary-item"><strong>Доп. опции:</strong></div>`;
                configuration.options.forEach(optionId => {
                    const option = optionsData.find(o => o.id === optionId);
                    if (option) {
                        html += `
                            <div class="summary-item">
                                <span>• ${option.name}</span>
                                <span>+${formatPrice(option.price)} ₽</span>
                            </div>
                        `;
                    }
                });
            }
            
            summaryContent.innerHTML = html;
            totalPriceElement.textContent = `Итого: ${formatPrice(configuration.totalPrice)} ₽`;
        }

        function formatPrice(price) {
            return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
        }

        function sendToManager() {
            const configData = {
                brand: configuration.brand,
                model: configuration.model,
                color: configuration.color,
                options: configuration.options,
                totalPrice: configuration.totalPrice,
                timestamp: new Date().toISOString()
            };
            
            tg.sendData(JSON.stringify(configData));
            
            tg.showPopup({
                title: 'Отправлено!',
                message: 'Конфигурация отправлена менеджеру.',
                buttons: [{ type: 'ok' }]
            });
        }

        // Функции возврата
        function backToBrands() { currentStep = 0; showStep(currentStep); }
        function backToModel() { currentStep = 1; showStep(currentStep); }
        function backToColor() { currentStep = 2; showStep(currentStep); }
        function backToOptions() { currentStep = 3; showStep(currentStep); }

        // Запуск приложения
        initializeApp();
    </script>
</body>
</html>
